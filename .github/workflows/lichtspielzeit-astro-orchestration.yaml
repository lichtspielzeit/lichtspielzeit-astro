# Please do not edit this file.
# Build steps can be customized in the lichtspielzeit-astro-build.yml file.
# More information can be found in https://docs.ionos.space/docs/github-actions-customization/
# version: 2022-07-21

name: 'Deploy Now: Orchestration'
run-name: 'Deploy Now: Build lichtspielzeit-astro'

on:
  push:
  workflow_dispatch:

jobs:
  retrieve-project:
    name: retrieve-project
    runs-on: ubuntu-latest
    outputs:
      deployment-enabled: ${{ steps.project.outputs.deployment-enabled }}
      branch-id: ${{ steps.project.outputs.branch-id }}
      site-url: ${{ steps.project.outputs.site-url }}
    steps:
      - name: Fetch project data
        uses: ionos-deploy-now/project-action@v1
        id: project
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: d1b19b77-8fa9-488a-a11c-aec59481b730
          action: retrieve-info

  build:
    name: build
    needs: retrieve-project
    if: ${{ needs.retrieve-project.outputs.deployment-enabled == 'true' }}
    uses: ./.github/workflows/lichtspielzeit-astro-build.yml
    with:
      site-url: ${{ needs.retrieve-project.outputs.site-url }}
      branch-id: ${{ needs.retrieve-project.outputs.branch-id }}
    secrets: inherit

  deploy:
    name: trigger deployment
    needs:
      - retrieve-project
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Dispatch deployment
        uses: ionos-deploy-now/dispatch-action@v1
        with:
          api-key: ${{ secrets.IONOS_API_KEY }}
          service-host: api-eu.ionos.space
          project-id: d1b19b77-8fa9-488a-a11c-aec59481b730
          branch-id: ${{ needs.retrieve-project.outputs.branch-id }}
          action: dispatch
